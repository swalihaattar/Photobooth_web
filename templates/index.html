<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vintage Photobooth</title>
  <!-- Google Analytics Tracking -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-GC658FXX9P"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-GC658FXX9P');
  </script> 
  <style>
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      text-align: center;
      background: linear-gradient(to bottom, #fff8dc, #a0522d); /* light yellow to sienna brown */
      font-family: 'Georgia', serif;
      color: #3e2723; /* dark brown for text */
    }


    h1 {
      margin-top: 30px;
      font-size: 3em;
      text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7);
      color: #8B4513; /* Vintage brown */
    }

    #video, #canvas {
      margin-top: 20px;
      border: 5px solid #8B4513; /* Vintage brown */
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }


    #start {
    margin-top: 15px;
    padding: 12px 25px;
    font-size: 1.2em;
    background-color: #bfa88e;
    border: none;
    border-radius: 8px;
    color: #8B4513;
    cursor: pointer;
    box-shadow: 2px 2px 6px rgba(0,0,0,0.5);
    transition: background-color 0.3s ease;
}

#filterToggle {
    margin-top: 15px;
    padding: 12px 25px;
    font-size: 1.2em;
    background-color: #bfa88e;
    border: none;
    border-radius: 8px;
    color: #8B4513;
    cursor: pointer;
    box-shadow: 2px 2px 6px rgba(0,0,0,0.5);
    transition: background-color 0.3s ease;
}

#start:hover, #filterToggle:hover {
    background-color: #a07c61;
}

    #start:hover {
      background-color: #a07c61;
    }

    /* Countdown styling */
    #countdown {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 100px;
      color: white;
      text-shadow: 2px 2px 10px black;
      display: none;
      z-index: 10;
    }
    
@keyframes fall {
  to { transform: translateY(100vh) rotate(360deg); }
}
  </style>
  <style>
    /* Mirror ball animation */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .mirror-ball {
      position: fixed;
      width: 80px;
      height: 80px;
      background: radial-gradient(circle at 30% 30%, 
        #fff 0%, 
        #ccc 10%, 
        #888 30%, 
        transparent 70%);
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(255,255,255,0.8);
      opacity: 0.7;
      z-index: -1;
      animation: spin 8s linear infinite;
    }
  </style>
</head>
<!-- Mirror balls -->
<div class="mirror-ball" style="top:10%; left:5%;"></div>
<div class="mirror-ball" style="bottom:15%; right:8%; animation-delay:-4s;"></div>
<script>
  // Floating stickers
  const stickers = ['üéûÔ∏è', 'üì∏', '‚ú®', 'üéâ'];
  function createSticker() {
    const sticker = document.createElement('div');
    sticker.textContent = stickers[Math.floor(Math.random()*stickers.length)];
    sticker.style.position = 'fixed';
    sticker.style.fontSize = `${Math.random()*30 + 20}px`;
    sticker.style.opacity = '0.7';
    sticker.style.animation = `float ${Math.random()*10 + 5}s linear infinite`;
    sticker.style.left = `${Math.random()*100}%`;
    sticker.style.top = `${Math.random()*100}%`;
    document.body.appendChild(sticker);
  }
  
  // Create 5 random stickers
  for(let i=0; i<5; i++) createSticker();
</script>

<style>
  @keyframes float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-50px) rotate(10deg); }
  }
</style>
<body>

  <h1>Vintage Party Photobooth üì∏</h1>

  <div>
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
    <br>
    <button id="start">Start Capture üé•</button>  
    <button id="filterToggle">Enable Vintage Filter ‚òëÔ∏è</button>  <!-- Add this line -->
 </div>
  <div id="countdown"></div> <!-- Countdown div -->

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startButton = document.getElementById('start');
    const countdownEl = document.getElementById('countdown'); 
    let context = canvas.getContext('2d');
    
    let capturedPhotos = [];
    
    // Start webcam
    navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
        video.srcObject = stream;
    })
    .catch(err => {
        console.error("Error accessing webcam: ", err);
    });
    
    // Sleep helper function
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // Capture single photo
    function capturePhoto() {
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        return canvas.toDataURL('image/png');
    }
    
    // Countdown function
    async function showCountdown() {
        countdownEl.style.display = 'block';
        for (let i = 3; i > 0; i--) {
            countdownEl.textContent = i;
            await sleep(1000);
        }
        countdownEl.textContent = "Click!"; // Show "Click!" after 1
        await sleep(500); // Show "Click!" briefly
        countdownEl.style.display = 'none';
    }
    
    function validateEmail(email) {
        if (!email) return false;
        const re = /\S+@\S+\.\S+/;
        return re.test(email);
    }
    
    // Countdown + Capture 3 photos
    document.getElementById('filterToggle').addEventListener('click', function() {
    this.textContent = this.textContent.includes('Disable') 
        ? 'Enable Vintage Filter ‚òëÔ∏è' 
        : 'Disable Vintage Filter ‚ùé';
    });
    
    startButton.addEventListener('click', async () => {
        capturedPhotos = [];

    // Send Google Analytics event
    gtag('event', 'start_capture', {
        'event_category': 'Photobooth',
        'event_label': 'User started capture'
    });

    // Capture 3 photos
    for (let i = 0; i < 3; i++) {
        await showCountdown();
       // Temporary canvas for filter application
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = video.videoWidth;
      tempCanvas.height = video.videoHeight;
      const ctx = tempCanvas.getContext('2d');
      ctx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);

// Apply filter ONLY if button says "Disable"
if (document.getElementById('filterToggle').textContent.includes('Disable')) {
    const imageData = ctx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
    const data = imageData.data;
    for (let i = 0; i < data.length; i += 4) {
        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
        data[i] = data[i + 1] = data[i + 2] = avg; // B&W effect
    }
    ctx.putImageData(imageData, 0, 0);
}

capturedPhotos.push(tempCanvas.toDataURL('image/png'));
        await sleep(500); // Short delay between shots
    }

    // Email input loop
    let email = null;
    let emailValid = false;
    let custom_text = "Vintage Memories";
    
    while (!emailValid) {
        email = prompt("Enter your email to receive your photo strip (or cancel to skip):");
        if (email === null) {
            // User canceled, don't send email
            gtag('event', 'email_submitted', {
                'event_category': 'Photobooth',
                'event_label': 'No email entered',
                'email_valid': 'none'
            });
            emailValid = true;  // Exit loop
        } else if (email === "") {
            // Blank email entered
            gtag('event', 'email_submitted', {
                'event_category': 'Photobooth',
                'event_label': 'Blank email entered',
                'email_valid': 'none'
            });
            alert("Please enter a valid email address.");
        } else if (!validateEmail(email)) {
            // Invalid email entered
            gtag('event', 'email_submitted', {
                'event_category': 'Photobooth',
                'event_label': 'Invalid email entered',
                'email_valid': 'invalid'
            });
            alert("Invalid email. Please enter a valid email.");
        } else {
            // Valid email entered
            gtag('event', 'email_submitted', {
                'event_category': 'Photobooth',
                'event_label': 'Email entered',
                'email_valid': 'valid'
            });
            emailValid = true;  // Exit loop if email is valid
        }
    }

    // Get custom text if email was provided
    if (email && validateEmail(email)) {
        custom_text = prompt("Enter text for your photo strip (or leave blank for default):");
    }

    // Send photo strip and email (only if email is valid)
    if (email && validateEmail(email)) {
        fetch('/capture', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
            photos: capturedPhotos,
            email: email,
            custom_text: custom_text || 'Vintage Memories',
            apply_filter: document.getElementById('filterToggle').textContent.includes('Disable')
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Photo strip created and sent!');
            } else {
                alert('Error: ' + (data.error || 'Unknown'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
});

    </script>
    
</body>
</html>
